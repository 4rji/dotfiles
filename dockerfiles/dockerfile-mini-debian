FROM debian:bookworm

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    xrdp \
    xorgxrdp \
    xfce4 \
    xfce4-terminal \
    firefox-esr \
    dbus-x11 \
    curl \
    ca-certificates \
    procps \
    && rm -rf /var/lib/apt/lists/*

# usuario dentro del contenedor
RUN useradd -m -s /bin/bash nala \
    && echo "nala:nala" | chpasswd \
    && adduser xrdp ssl-cert

# ----- perfil arkenfox endurecido -----
RUN mkdir -p /home/nala/.fx-profile \
    && curl -fsSL https://raw.githubusercontent.com/arkenfox/user.js/master/user.js \
      -o /home/nala/.fx-profile/user.js

RUN printf '%s\n' \
'user_pref("privacy.resistFingerprinting", true);' \
'user_pref("privacy.resistFingerprinting.randomization.enabled", true);' \
'' \
'user_pref("webgl.disabled", true);' \
'user_pref("webgl.enable-webgl2", false);' \
'' \
'user_pref("media.peerconnection.enabled", false);' \
'user_pref("media.navigator.enabled", false);' \
'user_pref("dom.webrtc.enabled", false);' \
'user_pref("media.eme.enabled", false);' \
'' \
'user_pref("dom.battery.enabled", false);' \
'user_pref("beacon.enabled", false);' \
'user_pref("device.sensors.enabled", false);' \
'user_pref("dom.gamepad.enabled", false);' \
'user_pref("dom.vibrator.enabled", false);' \
'user_pref("geo.enabled", false);' \
'' \
'user_pref("network.dns.disablePrefetch", true);' \
'user_pref("network.http.speculative-parallel-limit", 0);' \
'user_pref("network.predictor.enabled", false);' \
'user_pref("network.trr.mode", 5);' \
'' \
'user_pref("media.peerconnection.ice.default_address_only", true);' \
'user_pref("media.peerconnection.ice.no_host", true);' \
>> /home/nala/.fx-profile/user.js

# sesión gráfica: XFCE + Firefox auto
RUN printf '%s\n' \
'#!/bin/sh' \
'startxfce4 &' \
'exec firefox-esr -profile "$HOME/.fx-profile"' \
> /home/nala/.xsession \
 && chmod +x /home/nala/.xsession

# permisos home
RUN chown -R nala:nala /home/nala

USER nala
WORKDIR /home/nala

USER root
EXPOSE 3389

# xrdp como PID 1; contenedor muere limpio
CMD ["bash","-lc","dbus-daemon --system --fork; /usr/sbin/xrdp-sesman; exec /usr/sbin/xrdp -n"]