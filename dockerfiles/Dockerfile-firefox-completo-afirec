FROM debian:bookworm

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y \
        firefox-esr \
        locales \
        curl \
        ca-certificates \
        libgtk-3-0 \
        libdbus-glib-1-2 \
        libx11-xcb1 \
        libasound2 \
        libpci3 \
        libegl1 \
        x11-utils \
    && sed -i '/es_ES.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ---- usuario no-root ----
RUN useradd -m -s /bin/bash nala \
  && chown -R nala:nala /home/nala

USER nala
WORKDIR /home/nala

# ---- perfil firefox + arkenfox ----
RUN mkdir -p /home/nala/.fx-profile \
  && curl -fsSL https://raw.githubusercontent.com/arkenfox/user.js/master/user.js \
     -o /home/nala/.fx-profile/user.js

# ---- prefs extra + dark mode forzado ----
RUN printf '%s\n' \
'user_pref("privacy.resistFingerprinting", true);' \
'user_pref("privacy.resistFingerprinting.randomization.enabled", true);' \
'' \
'user_pref("webgl.disabled", true);' \
'user_pref("webgl.enable-webgl2", false);' \
'' \
'user_pref("media.peerconnection.enabled", false);' \
'user_pref("media.navigator.enabled", false);' \
'user_pref("dom.webrtc.enabled", false);' \
'user_pref("media.eme.enabled", false);' \
'' \
'user_pref("dom.battery.enabled", false);' \
'user_pref("beacon.enabled", false);' \
'user_pref("device.sensors.enabled", false);' \
'user_pref("dom.gamepad.enabled", false);' \
'user_pref("dom.vibrator.enabled", false);' \
'user_pref("geo.enabled", false);' \
'' \
'user_pref("network.dns.disablePrefetch", true);' \
'user_pref("network.http.speculative-parallel-limit", 0);' \
'user_pref("network.predictor.enabled", false);' \
'user_pref("network.trr.mode", 5);' \
'' \
'user_pref("media.peerconnection.ice.default_address_only", true);' \
'user_pref("media.peerconnection.ice.no_host", true);' \
'' \
'user_pref("ui.systemUsesDarkTheme", 1);' \
'user_pref("layout.css.prefers-color-scheme.content-override", 0);' \
>> /home/nala/.fx-profile/user.js

# perms por si acaso
USER root
RUN chown -R nala:nala /home/nala
USER nala

# ---- firefox siempre usando el perfil endurecido ----
ENTRYPOINT ["firefox-esr", "-profile", "/home/nala/.fx-profile"]
